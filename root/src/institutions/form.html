<script type="text/javascript">
  function previewLogo( file )
  {
    if ( !file ) return;
    let div = document.getElementById( 'logoPreview' );
    div.style.display = 'inline';

    let img = document.createElement( 'img' );
    img.file = file;
    img.width = 100;
    div.appendChild( img );

    let reader = new FileReader();
    reader.onload = ( function ( aImg ) { return function ( e ) { aImg.src = e.target.result; }; } )( img );
    reader.readAsDataURL( file );
  }

  function uploadLogo( file )
  {
    if ( !file ) return;

    let button = document.getElementById( 'save' );
    button.disabled = true;

    let formData = new FormData();
    formData.append( 'file', file );

    let xhr = new XMLHttpRequest();
    xhr.open( 'POST', '/logos/create' );
    xhr.onload = function ()
    {
      if ( 200 === xhr.status )
      {
        console.log( `Logo upload response: ${xhr.responseText}` );
        let json = JSON.parse( xhr.responseText );
        let input = document.createElement( 'input' );
        input.type = 'hidden';
        input.value = json.id;
        input.name = 'logoId';
        input.id = 'logoId';
        document.forms[0].appendChild( input );
      }
      else
      {
        let div = document.getElementById( 'logoPreview' );
        while ( div.firstChild ) div.removeChild( div.firstChild );
        let text = document.createTextNode( 'Error uploading logo image to server.  Please try again later' );
      }

      button.disabled = false;
    };
    xhr.send( formData );
  }

  function checkUnique( form )
  {
    let xhr = new XMLHttpRequest();
    xhr.open( 'POST', '/institutions/checkUnique' );
    xhr.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );
    xhr.onreadystatechange = function ()
    {
      let element = document.getElementById( 'nameWarning' );
      let response = xhr.responseText;
      console.log( `Check to see if institution ${form.name.value} in city ${form.city.value} exists returned ${response}.` );

      if ( 4 === xhr.readyState && 200 === xhr.status )
      {
        let available = 'true' === xhr.responseText;
        if ( !available )
        {
          element.style.display = 'inline';
          form.name.focus();
        }
        else
        {
          element.style.display = 'none';
          form.submit();
        }
      }
      else
      {
        element.style.display = 'inline';
        element.innerHTML = 'Unable to access server to validate name/city.  Please try again later';
      }
    };
    xhr.send( encodeURI( `name=${form.name.value}&city=${form.city.value}` ) );
  }

  function validate()
  {
    let form = document.forms[0];
    if ( form.id ) form.submit();
    else checkUnique( form );
  }
</script>

<div style="width: 90%; padding: 10px; align:center">
  <table border="0" cellspacing="5" cellpadding="5">
    <tr>
      <td>
        <form id="edit" method="post" action="/institutions/edit" onsubmit="return false;">
          {% if object %}
          <h2>Edit Institution</h2>
          {% else %}
          <h2 align="center">Create Institution</h2>
          {% endif %}
            
            <table>
                <tr>
                    <td>
                        <label class="label">Institution Name:</label>
                    </td>
                    <td>
                        <input name="name" id="name" type="text" size="35" width="50" required="required"
                 {% if object %}value="{{ object.name }}" {% endif %} />
                     <q id="nameWarning" class="warning" style="display: none;">Institution with specified name already exists in this city.</q>   
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <label class="label">Institution Type:</label>
                    </td>
                    <td>
                        <select id="InstitutionType" style="width:100%"></select>
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <label class="label">Address:</label>
                    </td>
                    <td>
                        <input name="address" id="address" type="text" size="35" width="250"
                 {% if object %}value="{{ object.address }}" {% endif %} />
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <label class="label">City:</label>
                    </td>
                    
                    <td>
                        <input name="city" id="city" type="text" size="35" width="100" required
                 {% if object %}value="{{ object.city }}" {% endif %} />
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <label class="label">State:</label>
                    </td>
                    
                    <td>
                        <select name="state" id="state" style="width:100%"
                                {% if object %}value="{{ object.state }}" {% endif %} >
                        <option value="AL">Alabama (AL)</option>
	<option value="AK">Alaska (AK)</option>
	<option value="AZ">Arizona (AZ)</option>
	<option value="AR">Arkansas (AR)</option>
	<option value="CA">California (CA)</option>
	<option value="CO">Colorado (CO)</option>
	<option value="CT">Connecticut (CT)</option>
	<option value="DE">Delaware (DE)</option>
	<option value="DC">District Of Columbia (DC)</option>
	<option value="FL">Florida (FL)</option>
	<option value="GA">Georgia (GA)</option>
	<option value="HI">Hawaii (HI)</option>
	<option value="ID">Idaho (ID)</option>
	<option value="IL">Illinois (IL)</option>
	<option value="IN">Indiana (IN)</option>
	<option value="IA">Iowa (IA)</option>
	<option value="KS">Kansas (KS)</option>
	<option value="KY">Kentucky (KY)</option>
	<option value="LA">Louisiana (LA)</option>
	<option value="ME">Maine (ME)</option>
	<option value="MD">Maryland (MD)</option>
	<option value="MA">Massachusetts (MA)</option>
	<option value="MI">Michigan (MI)</option>
	<option value="MN">Minnesota (MN)</option>
	<option value="MS">Mississippi (MS)</option>
	<option value="MO">Missouri (MO)</option>
	<option value="MT">Montana (MT)</option>
	<option value="NE">Nebraska (NE)</option>
	<option value="NV">Nevada (NV)</option>
	<option value="NH">New Hampshire (NH)</option>
	<option value="NJ">New Jersey (NJ)</option>
	<option value="NM">New Mexico (NM)</option>
	<option value="NY">New York (NY)</option>
	<option value="NC">North Carolina (NC)</option>
	<option value="ND">North Dakota (ND)</option>
	<option value="OH">Ohio (OH)</option>
	<option value="OK">Oklahoma (OK)</option>
	<option value="OR">Oregon (OR)</option>
	<option value="PA">Pennsylvania (PA)</option>
	<option value="RI">Rhode Island (RI)</option>
	<option value="SC">South Carolina (SC)</option>
	<option value="SD">South Dakota (SD)</option>
	<option value="TN">Tennessee (TN)</option>
	<option value="TX">Texas (TX)</option>
	<option value="UT">Utah (UT)</option>
	<option value="VT">Vermont (VT)</option>
	<option value="VA">Virginia (VA)</option>
	<option value="WA">Washington (WA)</option>
	<option value="WV">West Virginia (WV)</option>
	<option value="WI">Wisconsin (WI)</option>
	<option value="WY">Wyoming (WY)</option>
                        </select>
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <label class="label">Postal Code:</label>
                    </td>
                    <td>
                        <input name="postalCode" id="postalCode" type="text" size="35" width="100"
                 {% if object %}value="{{ object.postal_code }}" {% endif %} />
                    </td>
                </tr>
                
                <tr>
                    <td>
                       <label class="label">Country:</label> 
                    </td>
                    <td>
                        <input name="country" id="country" type="text" size="35" width="100" value="{% if object %}{{ object.country }}{% else %}USA{% endif %}" />
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <label class="label">URL:</label>
                    </td>
                    <td>
                        <input name="website" id="website" type="text" size="35"
                 {% if object %}value="{{ object.website }}" {% endif %} />
                    </td>
                </tr>
                
            </table>
          {% if object %}
          <input type="hidden" name="id" value="{{ object.id }}" />
          {% endif %}
        </form>
      </td>
    </tr>
    <tr>
      <td>
        <form id="logoUploadForm" onsubmit="return false;">
          <label class="label">Logo:</label>
          {% if object.logo %}
          <img src="/logos/{{ object.logo.id }}/display" id="logoImage" width="100" />
          <input type="hidden" name="logoId" value="{{ object.logo.id }}" />
          {% else %}
          <input type="file" id="logo" accept="image/*" />
          <span id="logoPreview" style="display: none;"></span>
          {% endif %}
          <br />
        </form>
        <button id="save" onclick="validate()">Save</button>
      </td>
    </tr>
  </table>
</div>

<script type="text/javascript">
  let fileElement = document.getElementById( 'logo' );
  fileElement.addEventListener( 'change', function ()
  {
    previewLogo( this.files[0] );
    uploadLogo( this.files[0] );
  } );
</script>
