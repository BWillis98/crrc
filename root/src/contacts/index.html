<script type="text/javascript">
  let contacts = {{ contacts }};
  var institutions = [];
    
    function getInstitutions()
    {
        let xhr = new XMLHttpRequest();
        xhr.open( 'POST', '/institutions' );
        xhr.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );
        xhr.onload = function ()
        {
          if ( xhr.status === 200 )
          {
            console.log( xhr.responseText );
            institutions = JSON.parse( xhr.responseText );
            populateInstitutionsSelect();
          }
          else
          {
            console.log( `Unable to retrieve institution list.  Server returned status: ${xhr.status}` );
          }
        };
        xhr.send( '' );
    }

  function sortContacts()
  {
    function compareInstitution( i1, i2 )
    {
      if ( i1.name < i2.name ) return -1;
      if ( i1.name > i2.name ) return 1;
      return 0;
    }
    function compareContact( c1, c2 )
    {
      if ( c1.name < c2.name ) return -1;
      if ( c1.name > c2.name ) return 1;
      if ( !isEmpty( c1.institution ) && !isEmpty( c2.institution ) )
      {
        return compareInstitution( c1.institution, c2.institution );
      }
      return 0;
    }
    contacts.sort( compareContact );
  }

  function display( contact )
  {
      let element = document.getElementById( 'lstBoxselectUser_ViewUser' );
      let option = document.createElement( 'option' );
      option.value = contact.id;
      option.textContent = contact.name ;
      element.appendChild( option );
      console.log(contact.name + "Retrieved");
  }

  function displayAll()
  {
    sortContacts();
    contacts.forEach( display );
  }
  function deletePerson( form )
  {
      /*
    return confirm( `Do you wish to permanently delete contact ${form.name.value}?` );
    */
  }
    
  function populateInstitutionsSelect()
    {
        let element = document.getElementById('institution');
        for (var i = 0; i < institutions.length; ++i)
            {
                let option = document.createElement( 'option' );
                option.value = institutions[i].id;
                option.textContent = institutions[i].name;
                element.appendChild( option );
            }
    }

    getInstitutions();
    
    function removeUser(){
        let select = document.getElementById('lstBoxselectUser_ViewUser');
        let contactId = select.options[select.selectedIndex].value;
        let contactName = select.options[select.selectedIndex].text;
        let xhr = new XMLHttpRequest();
        
        if(contactId == -1)
            {
                alert("Please select a User to Remove");
            }
        else{
              if( window.confirm("Are you sure you want to delete " + contactName + " ?"))
            {
                xhr.open('PUT' , '/contacts/remove' );
                xhr.setRequestHeader('content-Type', 'application/x-www-form-urlencoded');
                xhr.onload = function()
                {
                    if (xhr.status === 200 )
                        {
                            console.log(xhr.responseText );
                            let json = JSON.parse( xhr.responseText );
                            if(json.status && json.count === 1 )
                                {
                                    select.remove(select.selectedIndex);
                                     console.log(contactName + " is now Sucessfully deleted!");
                                }
                            else
                                {
                                    console.log("Error Deleting this person");         
                                }
                        }
                    else
                    {
                        console.log("xhr status is not 200");
                    }
                };
                xhr.send (`id=${contactId}` );
             }
        }
       
      
    }
    function displayContactDetails()
    {
        let select = document.getElementById('lstBoxselectUser_ViewUser');
        let contactId = select.options[select.selectedIndex].value;
        if(contactId == -1){
            alert("Please select a User to View Details");
        }
        else{
            window.location.href = `/contacts/id/${contactId}/view`;    
        }
        
    }
</script>

<div style="margin-left: auto; margin-right: auto;min-height: 700px ;">
    
  <h2>Manage Contacts</h2>
  <div>
    <!--div style="display:inline-block; float: left; padding: 10px;"><a href="/contacts/create" style="float: left;">Create Contact</a></div-->
    <div style="display:inline-block; overflow: hidden; width: 100px;"></div>
    <div style="display:inline-block; float: right; padding: 10px;">
      <form name="search" method="post" action="/contacts/search">
      <input type="text" name="text" placeholder="Search by name..."/><input type="submit" value="Find"/>
      </form>
    </div>
    <div style="clear: both;"></div>
  </div>
  {% if searchText %}
  <h3>Search results for ({{ searchText }})</h3>
  {% endif %}
  <div id="contacts">
       <div class="viewUserContainer">
            <div class="TitleHeader">
               <h4>View User</h4>
            </div> <!--End of Title Header </div-->
            <!--Start of div view Users Multiline Select -->
           <div style="margin-left: auto; margin-right: auto; width: 1000px;">
            <div class="viewUsersMultilineSelect">
               <select multiple id="lstBoxselectUser_ViewUser" style="font-size: 16px;">
                   <option value="-1" selected style="display: none;"></option>
                   <script type="text/javascript">displayAll();</script>
                   {% for contact in contacts %}
                   <option value="{{ contact.id }}" {% if contact.id == object.contact.id %}selected="selected"{% endif %}>{{contact.name}} </option> {% endfor %}
               </select>
               <br><br>
                <button onclick = "displayContactDetails()" class="selectUserButton">View User Details</button>
               <a href="/contacts/create"><input type="button" name="addUser" value="Add User" id="addUserButton"></a>
                <button class="removeUserButton" onclick="removeUser()">Remove User</button>
               
               <br>
            </div> <!--End of div viewUsersMultilineSelect -->
           
            <!--Start of div filterBy -->
            <div class="filterByInViewUsers">
               <h2 id="filterByHeader"> Filter By </h2>
               <fieldset>
                   <div>
                       <p id="instituteLabelInFilterBy"> Institute: </p>
                      <select class="commonCmbBox2CSS" id="institution" style="width: 300px;">
                       <option value="-1" selected>Select Institution</option>
                      </select>
                   </div>
                  
                  <br>
                  <p id="instituteIDLabelInFilterBy"> Search Institute: </p>
                  <input type="text" placeholder="This feature is currently not available" class="InstituteIdFilterTextBoxInFilterBy" disabled>
                  <br>
                   <button class="commonBtnInViewPrograms">Apply Filter</button><br>
               </fieldset>
               <fieldset>
                  <p class="roleLabelInFilterBy"> Role: </p>
                  <select name="role" id="role"  class="commonCmbBox2CSS"  {% if object.user %}{% else %}disabled{% endif %}>
                      <option value="-1" style="font-size: 16px;">Select Role</option>
                      {% for role in roles %}
                      <option value="{{ role.id }}" style="font-size: 16px;"
                              {% ifequal role.id object.user.role.id %}selected="selected" {% endifequal %}>
                        {{ role.role }}
                      </option>
                      {% endfor %}
                    </select>
                   <button class="commonBtnInViewPrograms">Apply Filter</button>
               </fieldset>
               <fieldset>
                 <form name="search" method="post" action="/contacts/search">
                        <p id="UserIDLabelInFilterBy"> User Name: </p><input type="text" name="text" class="selectUserTextBoxInFilterBy" placeholder="Search by name..."/>
                       <input type="submit"  class="commonBtnInViewPrograms" value="Find"/>
                    </form>
               </fieldset>
            </div> <!--End of div filterBy -->
           </div>
         </div><!--viewUserContainer-->
  </div>
</div>
